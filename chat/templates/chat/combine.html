{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/combine.css' %}">
</head>

<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Floating background elements -->
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <div class="main-container">
        <!-- Inbox Sidebar (Desktop Only) -->
        <div class="inbox-container" id="inboxContainer">
            <div class="inbox-header">
                <h2 class="inbox-title">
                    <a href="{% url 'home' %}">
                        <i class="fa fa-arrow-left" aria-hidden="true">
                        </i>
                    </a>
                    Messages
                </h2>
                <div class="inbox-stats">
                    <span class="conversation-count">{{ conversations|length }}</span>
                </div>
            </div>

            <div class="conversations-list">
                {% for convo in conversations %}
                <a href="{% url 'combined_chat' chatroom_id=convo.chatroom.id %}"
                    class="conversation-item {% if active_chatroom and active_chatroom.id == convo.chatroom.id %}active{% endif %}">
                    <div class="conversation-avatar">
                        <div class="avatar-circle">
                            {% if convo.user.userprofile.profile_photo %}
                            <img src="{{ convo.user.userprofile.profile_photo.url }}" alt="{{ convo.user.username }}"
                                class="profile-photo"
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            {% else %}
                            {{ convo.user.username.0|upper }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="conversation-content">
                        <div class="conversation-header">
                            <h3 class="username">{{ convo.user.username }}</h3>
                            <span class="message-time">
                                {% if convo.last_message %}
                                {{ convo.last_message.timestamp|timesince }} ago
                                {% endif %}
                            </span>
                        </div>

                        <div class="conversation-preview">
                            <p class="last-message">
                                {% if convo.last_message %}
                                {% if convo.last_message.sender == request.user %}
                                <span class="you-indicator">You: </span>
                                {% endif %}
                                {{ convo.last_message.content|truncatewords:8 }}
                                {% else %}
                                Start a conversation...
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="empty-inbox">
                    <div class="empty-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3>No messages yet</h3>
                    <p>Start a conversation!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container">
            {% if active_chatroom and other_user %}
            <!-- Chat Header -->
            <div class="chat-header">
                <!-- Mobile Conversations Horizontal Scroll -->
                <div class="mobile-conversations" id="mobileConversations">
                    {% for convo in conversations %}
                    <a href="{% url 'combined_chat' chatroom_id=convo.chatroom.id %}"
                        class="mobile-conversation-btn {% if active_chatroom and active_chatroom.id == convo.chatroom.id %}active{% endif %} {% if convo.unread_count > 0 %}has-unread{% endif %}"
                        title="{{ convo.user.username }}">
                        {% if convo.user.userprofile.profile_photo %}
                        <img src="{{ convo.user.userprofile.profile_photo.url }}" alt="{{ convo.user.username }}"
                            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        {{ convo.user.username.0|upper }}
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                <!-- Desktop Chat Header Info -->
                <div class="chat-header-info">
                    <div class="avatar">
                        {% if other_user.userprofile.profile_photo %}
                        <img src="{{ other_user.userprofile.profile_photo.url }}" alt="{{ other_user.username }}"
                            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        {{ other_user.username.0|upper }}
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3>
                            <a href="{% url 'profile_detail' other_user.username %}" alt="{{ convo.user.username }}"
                                class="following-username">
                                {{ other_user.username }}
                            </a>
                        </h3>
                    </div>
                    
                    <!-- NEW: Mobile Back Button - positioned on the right side -->
                    <a href="{% url 'home' %}" class="mobile-back-btn" title="Back to Home">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    
                    <form method="post" action="{% url 'delete_chat' active_chatroom.id %}"
                        onsubmit="return confirm('Are you sure you want to delete this entire chat?');">
                        {% csrf_token %}
                        <button type="submit" class="delete-chat-btn">
                            <i class="fas fa-trash"></i>
                            Clear
                        </button>
                    </form>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                {% for message in messages %}
                <div
                    class="message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                    <div class="message-bubble">
                        <div class="message-content">{{ message.content }}</div>

                        <div class="message-time">
                            {{ message.timestamp|date:"h:i A" }}

                            {% if message.sender == request.user %}
                            <form method="post" action="{% url 'delete_message' message.id %}" class="delete-form"
                                onsubmit="return confirm('Delete this message?');" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="delete-message-btn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <form method="post" class="message-form" id="messageForm">
                    {% csrf_token %}
                    <div class="input-group">
                        <div class="input-wrapper">
                            <textarea name="message" placeholder="Type a message..." required class="message-input"
                                id="messageInput"></textarea>
                        </div>
                        <button type="submit" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <!-- Empty State when no chat is selected -->
            <div class="empty-chat" style="width: 100%; height: 100%;">
                <div class="empty-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h3>Select a conversation</h3>
                <p>Choose a chat to start messaging</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="{% static 'java_script/combine.js' %}"></script>
</body>

</html>