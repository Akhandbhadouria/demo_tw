{% extends 'layout.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/profile_detail.css' %}">


<div class="dashboard">
    <!-- LEFT SIDEBAR - PROFILE -->
   <!-- LEFT SIDEBAR - PROFILE -->
<div class="left-sidebar">
    <div class="profile-card">
        <!-- Left Column: Profile Info -->
        <div class="profile-photo-wrapper">
            {% if profile.profile_photo %}
            <img src="{{ profile.profile_photo.url }}" alt="Profile" class="profile-photo">
            {% else %}
            <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=150&h=150&fit=crop"
                alt="Default Profile" class="profile-photo">
            {% endif %}
            <div class="status-indicator"></div>
        </div>
        
        <div class="profile-info-left">
            <div class="profile-name-container">
                <h2 class="profile-name">{{ profile.user.username }}</h2>
                {% if profile.profession %}
                <span class="profile-profession">{{ profile.profession }}</span>
                {% endif %}
                
            </div>
            
            {% if profile.email %}
            <p class="profile-email">{{ profile.email }}</p>
            {% endif %}
            
            {% if profile.bio %}
            <p class="profile-bio">BIO: {{ profile.bio }}</p>
            {% endif %}
        </div>

        <!-- Right Column: Stats -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-number">{{ profile.user.tweet_set.count|default:"0" }}</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ profile.followers_count }}</div>
                <div class="stat-label">Followers</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ profile.following_count }}</div>
                <div class="stat-label">Following</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ profile.total_likes_received|default:"0" }}</div>
                <div class="stat-label">Total Likes</div>
            </div>
        </div>

        <!-- Mobile Action Buttons -->
        {% if request.user != profile.user %}
        <div class="mobile-action-buttons">
            <!-- Follow/Following button -->
            <form method="post" action="{% url 'follow_user' profile.user.username %}" class="mobile-follow-form">
                {% csrf_token %}
                {% if request.user in profile.followers.all %}
                <button type="submit" class="mobile-action-btn mobile-follow-btn">
                    <span>üë•</span>
                    Following
                </button>
                {% else %}
                <button type="submit" class="mobile-action-btn mobile-follow-btn">
                    <span>‚ûï</span>
                    Follow
                </button>
                {% endif %}
            </form>

            <!-- Message button -->
            {% if request.user.is_authenticated and profile_user %}
            <a href="{% url 'start_chat' username=profile_user.username %}" class="mobile-action-btn mobile-message-btn">
                <span>üí¨</span>
                Message
            </a>
            {% endif %}
        </div>
        {% endif %}

        <div class="theme-toggle-wrapper">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        </div>
    </div>
</div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="header-bar">
            <h1 class="header-title">Profile Activity</h1>
            {% if request.user == profile.user %}
            <a href="{% url 'tweet_create' %}" class="btn btn-primary">New Post</a>
            {% else %}
            <div class="ms">
                <!-- Follow/Following button -->
                <form method="post" action="{% url 'follow_user' profile.user.username %}">
                    {% csrf_token %}
                    {% if request.user in profile.followers.all %}
                    <div style="display: flex;">
                        <div>
                            <button type="submit" class="btn btn-secondary">Following</button>
                        </div>
                        {% if request.user.is_authenticated and profile_user %}
                        <div> 
                            <a href="{% url 'start_chat' username=profile_user.username %}" class="btn btn-primary">
                                Message
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <button type="submit" class="btn btn-primary">Follow</button>
                    {% endif %}
                </form>
            </div>
            {% endif %}
        </div>

        <div class="post-card">
            {% if tweets %}
            <div class="masonry-grid" id="tweetsGrid">
                {% for tweet in tweets %}
                <div class="tweet-card {% if forloop.counter > 4 %}hidden{% endif %}" 
                     data-tweet-id="{{ tweet.id }}" 
                     data-tweet-text="{{ tweet.text }}"
                     data-tweet-photo="{% if tweet.photo %}{{ tweet.photo.url }}{% endif %}"
                     data-tweet-username="{{ tweet.user.username }}"
                     data-tweet-date="{{ tweet.updated_at|date:'M d, Y' }}"
                     data-tweet-userphoto="{% if tweet.user.userprofile.profile_photo %}{{ tweet.user.userprofile.profile_photo.url }}{% endif %}"
                     data-tweet-likes="{{ tweet.total_likes }}">

                    {% if tweet.photo %}
                    <img src="{{ tweet.photo.url }}" class="tweet-image" alt="Tweet Photo">
                    {% else %}
                    <div class="tweet-text-only">
                        <p>{{ tweet.text|truncatewords:20 }}</p>
                    </div>
                    {% endif %}

                    <!-- Like Button and Count -->
                    <div class="tweet-actions">
                        <form method="post" action="{% url 'like_tweet' tweet.id %}" class="like-form">
                            {% csrf_token %}
                           <button type="submit" class="like-btn {% if request.user in tweet.likes.all %}liked{% endif %}">
    <span class="like-icon">
        {% if request.user in tweet.likes.all %}
            ‚ù§Ô∏è
        {% else %}
            ü§ç
        {% endif %}
    </span>
    <span class="like-count">{{ tweet.total_likes }}</span>
</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Show more posts button -->
            {% if tweets|length > 4 %}
            <div class="show-more-container">
                <button id="showMoreBtn" class="show-more-btn">
                    +{{ tweets|length|add:"-4" }} more posts
                </button>
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h2 class="empty-state-title">No Posts yet</h2>
                <p class="empty-state-text">You haven't posted any post yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- RIGHT SIDEBAR -->
    <div class="right-sidebar">
        <div class="widget-card">
            <h3 class="widget-title">üë• Following</h3>
            {% if following %}
            <div class="horizontal-following-grid">
                {% for user in following|slice:":4" %}
                <div class="horizontal-user-item">
                    <a href="{% url 'profile_detail' user.username %}" class="horizontal-avatar-link">
                        {% if user.userprofile and user.userprofile.profile_photo %}
                        <img src="{{ user.userprofile.profile_photo.url }}" alt="{{ user.username }}"
                            class="horizontal-profile-photo">
                        {% else %}
                        <div class="horizontal-default-avatar">
                            <span class="horizontal-avatar-initial">{{ user.username|first|upper }}</span>
                        </div>
                        {% endif %}
                    </a>
                    <a href="{% url 'profile_detail' user.username %}" class="horizontal-username">
                        {{ user.username|truncatechars:8 }}
                    </a>
                </div>
                {% endfor %}
            </div>
            {% if following|length > 4 %}
            <div style="text-align: center; margin-top: 15px;">
                <a href="{% url 'following_list' profile.user.username %}" class="profile-link"
                    style="display: inline-flex; padding: 8px 16px; font-size: 0.8rem;">
                    +{{ following|length|add:"-4" }} more
                </a>
            </div>
            {% endif %}
            {% else %}
            <div class="empty-following-horizontal">
                <div class="empty-icon-horizontal"></div>
                <p class="empty-text-horizontal">Not following anyone yet</p>
            </div>
            {% endif %}
        </div>

        <div class="widget-card" style="display: flex;flex-direction: column; gap: 10px;">
            <h3 class="widget-title">Quick Links</h3>
            <a href="{% url 'edit_profile' %}" class="profile-link">
                <i class="fas fa-user-friends"></i> Edit Profile
            </a>
            <a href="{% url 'followers_list' profile.user.username %}" class="profile-link">
                <i class="fas fa-users"></i> View Followers
            </a>
            <a href="{% url 'following_list' profile.user.username %}" class="profile-link">
                <i class="fas fa-user-friends"></i> View Following
            </a>
            <a href="{% url 'account_settings' %}" class="profile-link">
             <i class="fa fa-cog" aria-hidden="true"></i> Update Password
            </a>
            {% if request.user == profile.user %}
            <a href="{% url 'delete_account' %}" class="btn btn-danger">
                Delete Account
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tweet Popup Modal -->
<div class="tweet-modal-overlay" id="tweetModal">
    <div class="tweet-modal-content">
        <button class="tweet-modal-close" id="closeTweetModal">&times;</button>
        <div id="tweetModalBody">
            <!-- Content will be inserted here by JavaScript -->
        </div>
    </div>
</div>

<script>
  // Tweet Modal functionality
    document.addEventListener('DOMContentLoaded', function () {
        const tweetCards = document.querySelectorAll('.tweet-card');
        const tweetModal = document.getElementById('tweetModal');
        const closeTweetModal = document.getElementById('closeTweetModal');
        const tweetModalBody = document.getElementById('tweetModalBody');
        const showMoreBtn = document.getElementById('showMoreBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const tweetsGrid = document.getElementById('tweetsGrid');

        // Show More functionality
        if (showMoreBtn) {
            showMoreBtn.addEventListener('click', function() {
                const hiddenTweets = document.querySelectorAll('.tweet-card.hidden');
                
                // Show loading spinner
                showMoreBtn.style.display = 'none';
                loadingSpinner.style.display = 'block';
                
                // Simulate loading delay for better UX
                setTimeout(() => {
                    // Show all hidden tweets
                    hiddenTweets.forEach((tweet, index) => {
                        setTimeout(() => {
                            tweet.classList.remove('hidden');
                            tweet.classList.add('show');
                        }, index * 100); // Stagger the animation
                    });
                    
                    // Hide the show more button after showing all tweets
                    setTimeout(() => {
                        showMoreBtn.style.display = 'none';
                        loadingSpinner.style.display = 'none';
                    }, hiddenTweets.length * 100 + 500);
                    
                }, 800);
            });
        }

        // Open modal on tweet card click
        tweetCards.forEach(card => {
            card.addEventListener('click', function () {
                const tweetId = this.getAttribute('data-tweet-id');
                const tweetText = this.getAttribute('data-tweet-text');
                const tweetPhoto = this.getAttribute('data-tweet-photo');
                const tweetUsername = this.getAttribute('data-tweet-username');
                const tweetDate = this.getAttribute('data-tweet-date');
                const tweetUserPhoto = this.getAttribute('data-tweet-userphoto');

                showTweetModal({
                    id: tweetId,
                    text: tweetText,
                    photo: tweetPhoto,
                    username: tweetUsername,
                    date: tweetDate,
                    userPhoto: tweetUserPhoto
                });
            });
        });

        // Close modal
        closeTweetModal.addEventListener('click', function () {
            tweetModal.style.display = 'none';
        });

        // Close modal when clicking outside
        tweetModal.addEventListener('click', function (e) {
            if (e.target === tweetModal) {
                tweetModal.style.display = 'none';
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && tweetModal.style.display === 'flex') {
                tweetModal.style.display = 'none';
            }
        });

        function showTweetModal(tweet) {
            let modalContent = '';

            if (tweet.photo && tweet.photo !== 'None') {
                modalContent += `<img src="${tweet.photo}" class="tweet-modal-image" alt="Tweet Photo">`;
            }

            modalContent += `
                <div class="tweet-modal-text">
                    ${tweet.text}
                </div>
                <div class="tweet-modal-info">
                    <div class="tweet-modal-user">
                        ${tweet.userPhoto && tweet.userPhoto !== 'None' ?
                    `<img src="${tweet.userPhoto}" class="tweet-modal-avatar" alt="${tweet.username}">` :
                    `<div style="width:40px;height:40px;border-radius:50%;background:#667eea;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold">${tweet.username.charAt(0).toUpperCase()}</div>`
                }
                        <span class="tweet-modal-username">${tweet.username}</span>
                    </div>
                    <div class="tweet-modal-date">${tweet.date}</div>
                </div>
            `;

            tweetModalBody.innerHTML = modalContent;
            tweetModal.style.display = 'flex';
        }
    });

    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');

        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme', 'dark');
        }
    }

    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function () {
        const savedTheme = localStorage.getItem('theme');
        const themeIcon = document.getElementById('theme-icon');

        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.setAttribute('data-theme', 'dark');
            themeIcon.className = 'fas fa-sun';
        }

        // Smooth fade-in animation
        const cards = document.querySelectorAll('.post-card, .widget-card, .profile-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
      document.querySelectorAll(".like-form").forEach(form => {
    form.addEventListener("click", function(e) {
        e.stopPropagation();   // STOP POPUP FROM OPENING
    });

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        e.stopPropagation();   // ALSO STOP MODAL FROM TRIGGERING

        const url = this.action;
        const countSpan = this.querySelector(".like-count");
        const icon = this.querySelector(".like-icon");
        const btn = this.querySelector(".like-btn");

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": this.querySelector("[name=csrfmiddlewaretoken]").value,
            },
        })
        .then(response => response.json())
        .then(data => {
            countSpan.textContent = data.total_likes;

            if (data.liked) {
                btn.classList.add("liked");
                icon.textContent = "‚ù§Ô∏è";
            } else {
                btn.classList.remove("liked");
                icon.textContent = "ü§ç";
            }
        })
        .catch(error => console.log(error));
    });
});
</script>

{% endblock %}



